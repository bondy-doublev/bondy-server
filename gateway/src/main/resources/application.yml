eureka:
  client:
    service-url:
      defaultZone: ${DISCOVERY_URL}/eureka/
    register-with-eureka: true
    fetch-registry: true
    registry-fetch-interval-seconds: 5
  instance:
    prefer-ip-address: true

server:
  port: ${SERVER_PORT}

management:
  server:
    port: ${ACTUATOR_PORT}
  endpoints:
    web:
      exposure:
        include: health,info,refresh
  endpoint:
    refresh:
      enabled: true


logging:
  level:
    root: WARN
    org.example: INFO


spring:
  application:
    name: gateway
  jackson:
    default-property-inclusion: non_null
  web:
    cors:
      mappings:
        '[/**]':
          allowed-origins:
            - http://localhost:8080
            - https://gateway.bondy.io.vn
          allowed-methods: GET,POST,PUT,PATCH,DELETE,OPTIONS
          allowed-headers: "*"
          allow-credentials: true
          max-age: 3600
  servlet:
    multipart:
      enabled: true
      max-file-size: 200MB
      max-request-size: 300MB
  main:
    banner-mode: off
  cloud:
    config:
      fail-fast: true
      retry:
        max-attempts: 6
        initial-interval: 1000
        multiplier: 1.5
        max-interval: 5000

    gateway:
      # ❌ KHÔNG áp dụng default-filters toàn cục cho WS route
      default-filters: [ ]

      routes:
        # ===== Business routes (HTTP) =====
        - id: auth-service
          uri: lb://auth-service
          predicates:
            - Path=/api/v1/auth/**,/api/v1/users/**
          filters:
            - StripPrefix=2
            - RemoveResponseHeader=Server
            - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials
            - name: RequestSize
              args:
                maxSize: 20MB
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY, GATEWAY_TIMEOUT, INTERNAL_SERVER_ERROR

        - id: mail-service
          uri: lb://mail-service
          predicates:
            - Path=/api/v1/mail/**
          filters:
            - StripPrefix=2
            - RemoveResponseHeader=Server
            - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY, GATEWAY_TIMEOUT, INTERNAL_SERVER_ERROR

        - id: communication-service
          uri: lb://communication-service
          predicates:
            - Path=/api/v1/chat/**,/api/v1/advert/**,/api/v1/mail/**,/api/v1/payment/**
          filters:
            - StripPrefix=2
            - RemoveResponseHeader=Server
            - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY, GATEWAY_TIMEOUT, INTERNAL_SERVER_ERROR

        - id: upload-service
          uri: lb://upload-service
          predicates:
            - Path=/api/v1/upload/**
          filters:
            - StripPrefix=2
            - RemoveResponseHeader=Server
            - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY, GATEWAY_TIMEOUT, INTERNAL_SERVER_ERROR

        # Route cho file static
        - id: upload-static
          uri: lb://upload-service
          predicates:
            - Path=/files/**
          filters:
            - StripPrefix=0   # strip = 0 nghĩa giữ nguyên path
            - PreserveHostHeader

        - id: notification-service
          uri: lb://notification-service
          predicates:
            - Path=/api/v1/notifications/**
          filters:
            - StripPrefix=2
            - RemoveResponseHeader=Server
            - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY, GATEWAY_TIMEOUT, INTERNAL_SERVER_ERROR

        - id: interaction-service
          uri: lb://interaction-service
          predicates:
            - Path=/api/v1/posts/**,/api/v1/comments/**,/api/v1/friendships/**,/api/v1/feeds/**,/api/v1/wall/**,/api/v1/shares/**,/api/v1/reels/**,/api/v1/medias/**
          filters:
            - StripPrefix=2
            - RemoveResponseHeader=Server
            - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY, GATEWAY_TIMEOUT, INTERNAL_SERVER_ERROR

        - id: moderation-service
          uri: lb://moderation-service
          predicates:
            - Path=/api/v1/moderation/**,/api/v1/reports/**,/api/v1/admin-actions/**,/api/v1/admin/reports/**
          filters:
            - StripPrefix=2
            - RemoveResponseHeader=Server
            - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY, GATEWAY_TIMEOUT, INTERNAL_SERVER_ERROR

        # ✅ WebSocket route riêng biệt (NO default filters)
        - id: notification-ws
          uri: lb:ws://notification-service
          predicates:
            - Path=/ws/notify/**, /ws/notify-sockjs/**
          filters:
            - PreserveHostHeader

        # ===== Swagger / Docs =====
        - id: auth-docs
          uri: lb://auth-service
          predicates:
            - Path=/docs/auth/v3/api-docs
          filters:
            - SetPath=/v3/api-docs

        - id: mail-docs
          uri: lb://mail-service
          predicates:
            - Path=/docs/mail/v3/api-docs
          filters:
            - SetPath=/v3/api-docs

        - id: communication-docs
          uri: lb://communication-service
          predicates:
            - Path=/docs/communication/v3/api-docs
          filters:
            - SetPath=/v3/api-docs

        - id: upload-docs
          uri: lb://upload-service
          predicates:
            - Path=/docs/upload/v3/api-docs
          filters:
            - SetPath=/v3/api-docs

        - id: notification-docs
          uri: lb://notification-service
          predicates:
            - Path=/docs/notification/v3/api-docs
          filters:
            - SetPath=/v3/api-docs

        - id: interaction-docs
          uri: lb://interaction-service
          predicates:
            - Path=/docs/interaction/v3/api-docs
          filters:
            - SetPath=/v3/api-docs

        - id: moderation-docs
          uri: lb://moderation-service
          predicates:
            - Path=/docs/moderation/v3/api-docs
          filters:
            - SetPath=/v3/api-docs

      globalcors:
        add-to-simple-url-handler-mapping: true
        corsConfigurations:
          '[/**]':
            allowedOrigins:
              - http://localhost:3000
              - http://localhost:3039
              - http://localhost:8080
              - https://bondy.io.vn
              - https://www.bondy.io.vn
              - https://dashboard.bondy.io.vn
              - https://gateway.bondy.io.vn
            allowedMethods: [ GET, POST, PUT, PATCH, DELETE, OPTIONS ]
            allowedHeaders: [ "*" ]
            allowCredentials: true
            maxAge: 3600

springdoc:
  swagger-ui:
    path: /swagger-ui.html
    persistAuthorization: true
    urls:
      - name: auth-service
        url: /docs/auth/v3/api-docs
      - name: mail-service
        url: /docs/mail/v3/api-docs
      - name: upload-service
        url: /docs/upload/v3/api-docs
      - name: notification-service
        url: /docs/notification/v3/api-docs
      - name: interaction-service
        url: /docs/interaction/v3/api-docs
      - name: communication-service
        url: /docs/communication/v3/api-docs
      - name: moderation-service
        url: /docs/moderation/v3/api-docs

gateway:
  internal-paths:
    - /api/v1/mail/**
    - /api/v1/notification/**
    - /api/v1/users/basic-profiles
    - /api/v1/users/{userId}/basic-profile
    - /api/v1/users/friend-count
    - /api/v1/notifications/notify
  jwt:
    secret: ${JWT_SECRET}
    issuer: ${JWT_ISSUER}
    public-paths:
      - /api/v1/advert/active
      - /api/v1/upload/**
      - /api/v1/reel/public
      - /api/v1/auth/oauth2
      - /api/v1/auth/login
      - /api/v1/auth/register/**
      - /api/v1/auth/verify/**
      - /api/v1/auth/refresh
      - /api/v1/auth/forgot-password
      - /api/v1/auth/reset-password
      - /api/v1/auth/reset-password-otp
      - /files/**
      # Should public
      - /actuator/**
      - /v3/api-docs/**
      - /swagger-ui/**
      - /swagger-ui.html
      - /docs/**
  api-key:
    header: ${API_KEY_HEADER}
    auth-url: ${API_KEY_CHECK_URL}
    public-paths:
      - /files/**
      - /actuator/**
      - /v3/api-docs/**
      - /swagger-ui/**
      - /swagger-ui.html
      - /docs/**
